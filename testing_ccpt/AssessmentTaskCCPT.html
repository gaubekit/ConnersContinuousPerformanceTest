{{ block title }}Conners CPT – Test{{ endblock }}
{{ block content }}

<style>
  body {
    margin: 0;
    background-color: #ffffff;
    font-family: sans-serif;
  }

  .my-box {
    border: 1px solid #ccc;
    padding: 40px 20px;
    background-color: #f9f9f9;
    max-width: 800px;
    margin: 50px auto;
    text-align: center;
  }

  #screen {
    font-size: 200px;          /* sehr große Schrift */
    font-weight: bold;
    text-align: center;

    /* innerhalb der Box zentrieren */
    display: flex;
    align-items: center;
    justify-content: center;

    height: 300px;             /* Höhe innerhalb der Box */
    margin-bottom: 20px;
    user-select: none;
  }

  .instruction {
    font-size: 22px;
    color: #444;
    margin-top: 20px;
  }
</style>

<div class="my-box">
  <div id="screen"></div>

  <div class="instruction">
    Press the <b>Space</b> key as soon as you see a letter – <b>but not</b> for „{{ C.NO_GO_LETTER }}“.
  </div>

  <input type="hidden" name="results_json" id="results_json">
</div>

<script>
  const STIM_MS = {{ STIM_DURATION_MS|json }};
  const RESPONSE_KEY = {{ RESPONSE_KEY|json }};
  const TRIALS = {{ TRIALS|json }};

  const screen = document.getElementById('screen');
  const results = [];
  let trialIndex = 0;
  let awaitingResponse = false;
  let trialStart = 0;
  let responseCaptured = false;

  function now(){ return performance.now(); }

  function showStim(letter){
    screen.textContent = letter;
  }

  function runTrial(){
    if(trialIndex >= TRIALS.length){
      finishTask();
      return;
    }
    const tr = TRIALS[trialIndex];
    responseCaptured = false;
    awaitingResponse = true;
    showStim(tr.letter);
    trialStart = now();

    setTimeout(()=>{
      screen.textContent = '';
      awaitingResponse = false;
      if(!responseCaptured){
        results.push({
          letter: tr.letter, is_no_go: tr.is_no_go,
          isi_ms: tr.isi_ms, responded: false
        });
      }
      setTimeout(()=>{
        trialIndex += 1;
        runTrial();
      }, tr.isi_ms - STIM_MS);
    }, STIM_MS);
  }

  window.addEventListener('keydown', ev=>{
    if(awaitingResponse && !responseCaptured && ev.code === "Space"){
      responseCaptured = true;
      const rt = now() - trialStart;
      const tr = TRIALS[trialIndex];
      results.push({
        letter: tr.letter, is_no_go: tr.is_no_go,
        isi_ms: tr.isi_ms, responded: true,
        rt_ms: Math.round(rt)
      });
    }
  });

  function finishTask(){
    document.getElementById('results_json').value = JSON.stringify(results);
    document.querySelector('form').submit();
  }

  setTimeout(runTrial, 1000);
</script>

{{ endblock }}
